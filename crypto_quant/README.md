# CryptoQuant: Qlib + ValueCell 币安永续合约交易系统

## 系统架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              CryptoQuant 系统架构                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        1. 数据采集层 (Data Collector)                │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │   │
│  │  │  币安API      │  │ Alternative  │  │  DefiLlama   │              │   │
│  │  │  (免费)       │  │   (免费)      │  │   (免费)     │              │   │
│  │  ├──────────────┤  ├──────────────┤  ├──────────────┤              │   │
│  │  │ • K线数据     │  │ • 恐惧贪婪   │  │ • TVL        │              │   │
│  │  │ • 资金费率    │  │   指数       │  │ • 稳定币供应  │              │   │
│  │  │ • 持仓量      │  │              │  │              │              │   │
│  │  │ • 多空比      │  │              │  │              │              │   │
│  │  │ • 订单簿      │  │              │  │              │              │   │
│  │  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘              │   │
│  │         │                 │                 │                       │   │
│  │         └─────────────────┴─────────────────┘                       │   │
│  │                           │                                         │   │
│  │                           ▼                                         │   │
│  │              ┌─────────────────────────┐                           │   │
│  │              │   统一数据格式 (Parquet)  │                           │   │
│  │              │   ~/.cryptoquant/data/   │                           │   │
│  │              └─────────────┬───────────┘                           │   │
│  └────────────────────────────┼────────────────────────────────────────┘   │
│                               │                                             │
│  ┌────────────────────────────┼────────────────────────────────────────┐   │
│  │                        2. Qlib适配层                                 │   │
│  ├────────────────────────────┼────────────────────────────────────────┤   │
│  │                            ▼                                        │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │                  CryptoDataHandler                           │   │   │
│  │  │  • 加载Parquet数据                                           │   │   │
│  │  │  • 转换为Qlib MultiIndex格式                                  │   │   │
│  │  │  • 支持 $funding_rate, $open_interest 等扩展字段              │   │   │
│  │  └─────────────────────────┬───────────────────────────────────┘   │   │
│  │                            │                                        │   │
│  │                            ▼                                        │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │                  CryptoFeatureEngine                         │   │   │
│  │  │  • 150+ 永续合约专用因子                                      │   │   │
│  │  │  • 资金费率因子 / 持仓量因子 / 多空因子                        │   │   │
│  │  │  • 订单簿微观结构因子                                         │   │   │
│  │  └─────────────────────────┬───────────────────────────────────┘   │   │
│  └────────────────────────────┼────────────────────────────────────────┘   │
│                               │                                             │
│  ┌────────────────────────────┼────────────────────────────────────────┐   │
│  │                        3. 策略层                                     │   │
│  ├────────────────────────────┼────────────────────────────────────────┤   │
│  │                            ▼                                        │   │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐  │   │
│  │  │   ML模型训练      │  │   信号生成器      │  │   回测引擎       │  │   │
│  │  │   (LightGBM)     │  │   (多空信号)      │  │   (支持做空)     │  │   │
│  │  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘  │   │
│  │           │                     │                     │            │   │
│  │           └─────────────────────┴─────────────────────┘            │   │
│  │                                 │                                   │   │
│  └─────────────────────────────────┼───────────────────────────────────┘   │
│                                    │                                        │
│  ┌─────────────────────────────────┼───────────────────────────────────┐   │
│  │                        4. 执行层                                     │   │
│  ├─────────────────────────────────┼───────────────────────────────────┤   │
│  │                                 ▼                                   │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │                  SignalToTradeAdapter                        │   │   │
│  │  │  • Qlib信号 → ValueCell TradeInstruction                     │   │   │
│  │  │  • 仓位计算 / 杠杆控制 / 风控检查                              │   │   │
│  │  └─────────────────────────┬───────────────────────────────────┘   │   │
│  │                            │                                        │   │
│  │                            ▼                                        │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │              ValueCell CCXTExecutionGateway                  │   │   │
│  │  │  • 币安USDT-M永续合约                                         │   │   │
│  │  │  • open_long / open_short / close_long / close_short         │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 目录结构

```
crypto_quant/
├── README.md                    # 本文件
├── requirements.txt             # 依赖
├── config/
│   ├── settings.yaml           # 系统配置
│   └── symbols.yaml            # 交易标的配置
├── data_collector/
│   ├── __init__.py
│   ├── base.py                 # 采集器基类
│   ├── binance_collector.py    # 币安数据采集
│   ├── sentiment_collector.py  # 情绪数据采集
│   └── scheduler.py            # 定时调度
├── qlib_adapter/
│   ├── __init__.py
│   ├── data_handler.py         # 数据处理器
│   ├── feature_engine.py       # 因子引擎
│   └── backtest_engine.py      # 回测引擎(支持做空)
├── strategy/
│   ├── __init__.py
│   ├── ml_strategy.py          # ML策略
│   └── signal_generator.py     # 信号生成
├── execution/
│   ├── __init__.py
│   ├── adapter.py              # Qlib→ValueCell适配器
│   ├── risk_manager.py         # 风控模块
│   └── position_manager.py     # 仓位管理
├── scripts/
│   ├── collect_data.py         # 数据采集脚本
│   ├── train_model.py          # 模型训练脚本
│   ├── backtest.py             # 回测脚本
│   └── live_trade.py           # 实盘交易脚本
└── tests/
    └── test_*.py               # 测试文件
```

## 快速开始

```bash
# 1. 安装依赖
pip install -r requirements.txt

# 2. 配置
cp config/settings.yaml.example config/settings.yaml
# 编辑配置文件

# 3. 采集数据
python scripts/collect_data.py --days 365

# 4. 训练模型
python scripts/train_model.py

# 5. 回测验证
python scripts/backtest.py

# 6. 实盘交易 (谨慎!)
python scripts/live_trade.py --paper  # 先用模拟盘
```
