# .github/workflows/update-config-hash.yml
# 配置哈希自动更新工作流
# 当配置文件变更时，自动计算并更新 config_hash

name: Update Config Hashes

on:
  push:
    paths:
      - 'config/**/*.yaml'
    # 排除 bot 自己的提交，防止死循环
    branches-ignore:
      - 'dependabot/**'

# 必须有 write 权限才能 push
permissions:
  contents: write

jobs:
  update-hashes:
    runs-on: ubuntu-latest
    # 跳过自动更新触发的提交
    if: "!contains(github.event.head_commit.message, 'chore: auto-update')"

    steps:
      - uses: actions/checkout@v4
        with:
          # 使用 token 以便 push
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install ruamel.yaml==0.18.6

      - name: Update config hashes
        id: update
        run: |
          python scripts/ci/update_config_hashes.py
          # 检查是否有实际变更
          if git diff --quiet config/; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
          else
            echo "no_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit updated hashes
        # 只在有变更时提交
        if: steps.update.outputs.no_changes == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add config/
          # commit message 带特殊标记，用于上面的 if 判断
          git commit -m "chore: auto-update config hashes [skip ci]"
          git push
