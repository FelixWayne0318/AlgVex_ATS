# .github/workflows/boundary-check.yml
# 边界检查工作流
# 验证模块边界和数据访问规范

name: Boundary Check

on: [push, pull_request]

jobs:
  check-imports:
    name: Check Import Boundaries
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pyyaml

      - name: Check import boundaries
        run: python scripts/ci/check_import_boundary.py

      - name: Check data access patterns
        run: python scripts/ci/check_data_access.py

  verify-production-isolation:
    name: Verify Production Without Qlib
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install production dependencies only
        run: |
          pip install numpy pandas pyyaml

      - name: Verify production imports without qlib
        run: |
          python -c "
          import sys
          # 确保 qlib 不可用
          if 'qlib' in sys.modules:
              del sys.modules['qlib']

          # 尝试导入 production 模块
          try:
              from algvex.production import factor_engine
              from algvex.production import signal_generator
              from algvex.production import model_loader
              print('Production modules imported successfully without qlib')
          except ImportError as e:
              if 'qlib' in str(e).lower():
                  print(f'ERROR: Production depends on qlib: {e}')
                  sys.exit(1)
              else:
                  # 其他依赖缺失是允许的
                  print(f'Non-qlib import error (acceptable): {e}')
          "

      - name: Verify shared modules without qlib
        run: |
          python -c "
          import sys
          try:
              from algvex.shared import visibility_checker
              from algvex.shared import time_provider
              print('Shared modules imported successfully without qlib')
          except ImportError as e:
              if 'qlib' in str(e).lower():
                  print(f'ERROR: Shared depends on qlib: {e}')
                  sys.exit(1)
              else:
                  print(f'Non-qlib import error (acceptable): {e}')
          "
