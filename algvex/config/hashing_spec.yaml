# ============================================================
# 文件: config/hashing_spec.yaml
# 说明: Canonical Hashing 规范 (S9)
# ============================================================
config_version: "1.0.0"
config_hash: "sha256:hashing_v1_placeholder"

# ============================================================
# 全局哈希配置
# ============================================================
global_config:
  # 哈希算法
  algorithm: "sha256"

  # 输出格式
  output_format: "sha256:{hash_value[:16]}"

  # 字符编码
  encoding: "utf-8"

# ============================================================
# 配置文件哈希规范
# ============================================================
config_hash_spec:
  # 哈希计算规则
  rules:
    - "排除 config_hash 字段本身"
    - "对 YAML 内容进行规范化 JSON 序列化"
    - "排序所有键"
    - "使用紧凑分隔符: [',', ':']"

  # 计算流程
  algorithm: |
    1. 加载 YAML 文件为 dict
    2. 删除 'config_hash' 键
    3. 递归排序所有嵌套 dict 的键
    4. 使用 json.dumps(data, sort_keys=True, separators=(',', ':'))
    5. 对 JSON 字符串计算 SHA256
    6. 格式化为 "sha256:{hash[:16]}"

  # 验证时机
  validation_points:
    - "应用启动时"
    - "配置重载时"
    - "CI/CD 流水线"

# ============================================================
# 数据哈希规范
# ============================================================
data_hash_spec:
  # DataFrame 哈希
  dataframe:
    algorithm: |
      1. 按列名排序列
      2. 按索引排序行 (如果索引是时间，按时间升序)
      3. 转换为 bytes: df.to_csv(index=True).encode('utf-8')
      4. 计算 SHA256

    # 浮点数处理
    float_handling:
      precision: 8
      format: "{:.8f}"
      strip_trailing_zeros: true

  # 因子值哈希
  factor_values:
    algorithm: |
      1. 将因子值 dict 按键排序
      2. 浮点数格式化为 8 位精度字符串
      3. JSON 序列化 (sort_keys=True)
      4. 计算 SHA256

# ============================================================
# Trace 哈希规范
# ============================================================
trace_hash_spec:
  # Trace 序列化规范
  serialization:
    format: "json"
    sort_keys: true
    separators: [",", ":"]
    ensure_ascii: false

  # 类型规范化
  type_normalization:
    datetime: "ISO8601 UTC: %Y-%m-%dT%H:%M:%S.%fZ"
    decimal: "字符串表示 (保留精度)"
    float: "8位精度字符串: {:.8f}"
    set: "排序后的列表"
    none: "null"

  # data_hash 计算
  data_hash_fields:
    - "factors_used"
    - "input_data"

# ============================================================
# 快照哈希规范
# ============================================================
snapshot_hash_spec:
  # 快照ID生成
  snapshot_id_format: "snap_{cutoff_time}_{content_hash[:16]}"

  # 内容哈希计算
  content_hash:
    includes:
      - "所有数据文件内容"
      - "元数据文件"
    algorithm: |
      1. 列出快照目录下所有文件 (按名称排序)
      2. 计算每个文件的 SHA256
      3. 拼接: "{filename}:{file_hash}\n"
      4. 对拼接结果计算 SHA256

# ============================================================
# 代码哈希规范
# ============================================================
code_hash_spec:
  # 代码版本标识
  source: "git"

  # 计算方式
  algorithm: |
    1. 优先使用 git rev-parse HEAD
    2. 如果不在 git 仓库，使用关键文件的组合哈希
    3. 格式: "git:{commit_hash[:8]}" 或 "files:{hash[:8]}"

  # 关键文件 (用于非 git 环境)
  critical_files:
    - "production/factor_engine.py"
    - "production/signal_generator.py"
    - "shared/visibility_checker.py"
    - "config/visibility.yaml"
    - "config/factor_governance.yaml"

# ============================================================
# 验证规则
# ============================================================
validation:
  # 哈希不匹配时的行为
  on_mismatch:
    config_hash: "reject"     # 拒绝启动
    data_hash: "warn"         # 警告但继续
    code_hash: "log"          # 仅记录

  # 错误消息模板
  error_templates:
    config_integrity: |
      配置文件完整性校验失败!
      文件: {filename}
      预期: {expected_hash}
      实际: {actual_hash}
      请运行 scripts/update_config_hash.py 更新哈希，或检查是否有未授权的修改。

    data_mismatch: |
      数据哈希不匹配!
      快照: {snapshot_id}
      预期: {expected_hash}
      实际: {actual_hash}
      可能原因: 数据文件被修改、不同版本的数据源

# ============================================================
# 工具脚本配置
# ============================================================
tools:
  # 更新配置哈希脚本
  update_config_hash:
    script: "scripts/update_config_hash.py"
    usage: "python scripts/update_config_hash.py config/*.yaml"

  # 验证配置哈希脚本
  verify_config_hash:
    script: "scripts/verify_config_hash.py"
    usage: "python scripts/verify_config_hash.py"
    ci_integration: true
