# ============================================================
# 数据契约: 5分钟K线数据
# 文件: config/data_contracts/klines_5m.yaml
# ============================================================

contract_version: "1.0.0"
contract_hash: ""  # 自动计算

# 基本信息
source_id: "klines_5m"
description: "5分钟K线数据 (OHLCV)"
provider: "binance"
tier: "A"  # A=核心/B=重要/C=辅助

# 数据频率
frequency: "5min"
bar_duration_seconds: 300

# 可见性规则
visibility:
  type: "bar_close"
  delay: "0s"
  description: "K线收盘后立即可见"

# 数据模式 (Schema)
schema:
  fields:
    - name: "open_time"
      type: "datetime"
      description: "K线开盘时间 (UTC)"
      nullable: false

    - name: "open"
      type: "float64"
      description: "开盘价"
      nullable: false
      constraints:
        min: 0

    - name: "high"
      type: "float64"
      description: "最高价"
      nullable: false
      constraints:
        min: 0

    - name: "low"
      type: "float64"
      description: "最低价"
      nullable: false
      constraints:
        min: 0

    - name: "close"
      type: "float64"
      description: "收盘价"
      nullable: false
      constraints:
        min: 0

    - name: "volume"
      type: "float64"
      description: "成交量"
      nullable: false
      constraints:
        min: 0

    - name: "quote_volume"
      type: "float64"
      description: "成交额 (USDT)"
      nullable: false
      constraints:
        min: 0

    - name: "trades"
      type: "int64"
      description: "成交笔数"
      nullable: false
      constraints:
        min: 0

    - name: "taker_buy_volume"
      type: "float64"
      description: "主动买入量"
      nullable: false
      constraints:
        min: 0

    - name: "taker_buy_quote_volume"
      type: "float64"
      description: "主动买入额"
      nullable: false
      constraints:
        min: 0

  # 主键
  primary_key: ["symbol", "open_time"]

  # 索引
  indexes:
    - ["open_time"]
    - ["symbol", "open_time"]

# 数据质量规则
quality_rules:
  # 完整性检查
  completeness:
    max_missing_ratio: 0.01  # 最多1%缺失
    required_fields: ["open", "high", "low", "close", "volume"]

  # 一致性检查
  consistency:
    - rule: "high >= low"
      description: "最高价必须>=最低价"
    - rule: "high >= open"
      description: "最高价必须>=开盘价"
    - rule: "high >= close"
      description: "最高价必须>=收盘价"
    - rule: "low <= open"
      description: "最低价必须<=开盘价"
    - rule: "low <= close"
      description: "最低价必须<=收盘价"

  # 时效性检查
  timeliness:
    max_delay_seconds: 10  # 最大延迟10秒

  # 异常值检查
  outliers:
    price_change_threshold: 0.5  # 单根K线涨跌幅超50%告警

# API配置
api:
  endpoint: "https://fapi.binance.com/fapi/v1/klines"
  rate_limit:
    weight: 1
    max_per_minute: 1200
  params:
    interval: "5m"
    limit: 1500  # 最大返回条数

# 存储配置
storage:
  table_name: "binance_klines_5m"
  partition_by: "month"
  retention_days: 365
