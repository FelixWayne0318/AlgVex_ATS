# ============================================================
# 数据契约: 8小时资金费率
# 文件: config/data_contracts/funding_8h.yaml
# ============================================================

contract_version: "1.0.0"
contract_hash: ""  # 自动计算

# 基本信息
source_id: "funding_8h"
description: "资金费率 (每8小时结算)"
provider: "binance"
tier: "A"  # A档：核心数据

# 数据频率
frequency: "8h"
settlement_times:
  - "00:00"  # UTC
  - "08:00"
  - "16:00"

# 可见性规则 (关键!)
visibility:
  type: "scheduled"
  delay: "0s"
  schedule: ["00:00", "08:00", "16:00"]  # UTC
  description: "结算时刻立即可见"

  # 重要说明:
  # funding_momentum 因子必须用"结算次数"作为窗口
  # MA(3) = 最近3次结算 = 24小时
  # MA(8) = 最近8次结算 = 64小时
  # 禁止: 对 forward-fill 后的 5m 序列用 rolling(n_bars)

# 数据模式
schema:
  fields:
    - name: "funding_time"
      type: "datetime"
      description: "资金费率结算时间 (UTC)"
      nullable: false

    - name: "symbol"
      type: "string"
      description: "交易对 (如 BTCUSDT)"
      nullable: false

    - name: "funding_rate"
      type: "float64"
      description: "资金费率 (如 0.0001 = 0.01%)"
      nullable: false
      constraints:
        min: -0.05  # 极端负费率
        max: 0.05   # 极端正费率

    - name: "mark_price"
      type: "float64"
      description: "结算时标记价格"
      nullable: true
      constraints:
        min: 0

  primary_key: ["symbol", "funding_time"]

  indexes:
    - ["funding_time"]
    - ["symbol", "funding_time"]

# 数据质量规则
quality_rules:
  completeness:
    max_missing_ratio: 0.0  # 不允许缺失！资金费率是确定性事件
    required_fields: ["funding_rate"]

  consistency:
    - rule: "funding_rate >= -0.05 and funding_rate <= 0.05"
      description: "资金费率在合理范围内"

  timeliness:
    max_delay_seconds: 60  # 结算后1分钟内必须获取

# 因子计算规则
factor_rules:
  funding_momentum:
    description: "资金费率动量因子"
    window_type: "settlement_events"  # 不是 bars!
    fast_n: 3   # 3次结算 = 24h
    slow_n: 8   # 8次结算 = 64h
    formula: "MA(funding_rate, 3) - MA(funding_rate, 8)"

    # 正确实现方式
    implementation: |
      # 只取结算时刻的值 (00:00, 08:00, 16:00 UTC)
      settlements = funding_8h[funding_8h.index.hour.isin([0, 8, 16])]
      ma_fast = settlements['funding_rate'].rolling(3).mean()
      ma_slow = settlements['funding_rate'].rolling(8).mean()
      funding_momentum = ma_fast - ma_slow
      # 然后 forward-fill 到 5m 时间轴

    # 禁止的错误实现
    prohibited_patterns:
      - "rolling(n_bars) on forward-filled 5m series"
      - "使用5分钟bars作为窗口"

# API配置
api:
  endpoint: "https://fapi.binance.com/fapi/v1/fundingRate"
  rate_limit:
    weight: 1
    max_per_minute: 500
  params:
    limit: 1000

# 存储配置
storage:
  table_name: "binance_funding"
  partition_by: "month"
  retention_days: 365
