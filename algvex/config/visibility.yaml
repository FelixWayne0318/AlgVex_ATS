# ============================================================
# AlgVex 可见性规则配置
# 文件: config/visibility.yaml
# 说明: 定义数据可见性规则，防止未来信息泄露 (Lookahead)
# 版本: 2.0.0
# ============================================================

config_version: "2.0.0"
config_hash: ""  # 由 config_validator.py 自动计算

# ============================================================
# 核心规则: 任何数据可用 当且仅当 visible_time <= snapshot_cutoff
# ============================================================
#
# 定义:
#   signal_time = bar_close_time (MVP固定为5分钟K线收盘时间)
#   snapshot_cutoff = signal_time (对于 bar_close 类型数据)
#   visible_time = 按数据类型计算 (见下方 visibility_types)
#
# 重要修正 (v1.1.0):
#   - bar_close 数据: snapshot_cutoff = signal_time (无安全边际)
#     原因: bar_close_time = signal_time, 若有 safety_margin 会导致当前 bar 数据不可见
#   - realtime 数据: 使用 latency_buffer 处理网络延迟
#   - bar_close_delayed 数据: 使用 publication_delay 处理发布延迟
#
# ============================================================

# 快照截止规则
# 注意: safety_margin 仅用于 realtime 数据的网络延迟保护
# 对于 bar_close 数据，snapshot_cutoff = signal_time (即 safety_margin = 0)
snapshot_cutoff_rule: "signal_time - safety_margin"
safety_margin: "0s"  # v1.1.0修正: 改为0s，避免 bar_close 数据不可见的逻辑矛盾

# ============================================================
# 可见性类型定义
# ============================================================
visibility_types:
  # 实时数据：几乎无延迟
  realtime:
    description: "实时数据，采集延迟约1秒"
    rule: "event_time + latency_buffer"
    latency_buffer: "1s"
    examples:
      - mark_price      # 标记价格
      - last_price      # 最新成交价
      - best_bid        # 最优买价
      - best_ask        # 最优卖价

  # Bar收盘数据：K线收盘后完整可见
  bar_close:
    description: "Bar聚合数据，bar收盘后立即可见"
    rule: "bar_close_time + 0s"
    examples:
      - ohlcv           # K线数据
      - taker_volume    # 主动买卖量
      - cvd_5m          # 5分钟累积成交量差

  # Bar收盘+延迟数据：有发布延迟
  bar_close_delayed:
    description: "Bar聚合+延迟数据，需等待发布"
    rule: "bar_close_time + publication_delay"
    publication_delay: "5min"  # 默认5分钟延迟
    examples:
      - open_interest   # 持仓量
      - long_short_ratio # 多空比

  # 定时发布数据：按固定时间发布
  scheduled:
    description: "定时发布数据（如资金费率）"
    rule: "scheduled_time + publication_delay"
    publication_delay: "0s"
    schedule_times:
      - "00:00"  # UTC
      - "08:00"
      - "16:00"
    examples:
      - funding_rate    # 资金费率

# ============================================================
# 数据源 -> 可见性类型 映射
# ============================================================
source_visibility_map:
  # A档数据源 (MVP核心)
  klines_5m: bar_close
  funding_8h: scheduled

  # B档数据源 (有延迟)
  open_interest_5m: bar_close_delayed
  long_short_ratio: bar_close_delayed
  taker_buy_sell: bar_close

  # 实时数据
  mark_price: realtime
  order_book: realtime

# ============================================================
# 数据源延迟覆盖 (特定数据源的延迟配置)
# ============================================================
source_delay_overrides:
  open_interest_5m:
    publication_delay: "5min"
    description: "币安OI数据有约5分钟延迟"

  long_short_ratio:
    publication_delay: "5min"
    description: "多空比数据有约5分钟延迟"

# ============================================================
# 安全边际配置
# ============================================================
safety_margins:
  default: "0s"
  conservative: "5s"
  # 注意: 禁止使用负值！负值会导致 lookahead 风险

# ============================================================
# 验证规则
# ============================================================
validation:
  # 是否严格检查可见性
  strict_mode: true

  # 违规处理方式: "error" | "warning" | "ignore"
  on_violation: "error"

  # 是否记录所有可见性检查
  log_all_checks: false
